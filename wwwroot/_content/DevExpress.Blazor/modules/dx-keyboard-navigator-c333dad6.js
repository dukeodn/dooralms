import{E as e}from"./eventhelper-8570b930.js";import{L as t,D as n}from"./layouthelper-2d7ade10.js";import{k as s}from"./key-758f2153.js";import{FocusableElementsSelector as i,attachEventsForFocusHiding as r,addFocusHiddenClassName as a,removeFocusHiddenClassName as o,hasClosestFocusableElement as l}from"./focus-utils-24f244e4.js";import{f as d,s as c}from"./dom-utils-55c8e5bb.js";import{C as h}from"./custom-events-helper-e7f279d3.js";class m{constructor(e,t){this._nestedContentSelected=!1,this._selectedItemIndex=0,this.savedSelectedItemElement=null,this._navigator=e,this._targetElement=t,this._items=[]}get navigator(){return this._navigator}get targetElement(){return this._targetElement}get nestedContentSelected(){return this._nestedContentSelected}set nestedContentSelected(e){this._nestedContentSelected=e&&this.canFocusSelectedItem()}get selectedItemIndex(){return this._selectedItemIndex}set selectedItemIndex(e){this._selectedItemIndex=e}get selectedItemElement(){return this.items[this.selectedItemIndex]}get itemCount(){return this.items.length}get isObsolete(){return!1}get items(){return this._items}getShortcutContext(){return{}}initialize(){this.storeSelection(),this.items.splice(0);const e=this.queryItems().filter((e=>!!e));0===e.length&&e.push(this.targetElement);for(const t of e){this.items.push(t);let e=this.navigator.getStrategy(t);e&&!e.isObsolete||(e=this.createItemStrategy(t),this.navigator.attachStrategy(e)),e&&e!==this&&e.initialize()}this.restoreSelection()}storeSelection(){this.savedSelectedItemElement=this.selectedItemElement}restoreSelection(){this.savedSelectedItemElement&&this.tryRestoreSelectedItem(this.savedSelectedItemElement),this.savedSelectedItemElement=null}queryItems(){return new Array}queryItemsBySelector(e){return Array.from(this.targetElement.querySelectorAll(e))}createItemStrategy(e){return null}getItem(e){return this.items[e]}getItemStrategy(e){return this.navigator.getStrategy(this.getItem(e))}getSelectedItemStrategy(){return this.navigator.getStrategy(this.selectedItemElement)}activate(){this.selectItem(this.selectedItemIndex)}onDispose(){var e;(null===(e=this.selectedItemElement)||void 0===e?void 0:e.isConnected)&&m.removeTabIndex(this.selectedItemElement)}updateSelectedItemByChildElement(e,t){const n=this.findItemElementIndexByChild(e);this.updateSelectedItemByIndex(n)}focusSelectedItem(){this.canFocusSelectedItem()&&d(this.selectedItemElement)}captureFocus(){this.nestedContentSelected&&this.leaveFromNestedContent()}findLastSelectedStrategy(){const e=this.getSelectedItemStrategy();return e&&e!==this?e.findLastSelectedStrategy():this}findItemElementIndexByChild(e){return m.findItemElementIndexByChild(this.items,e)}selectItem(e){var t;this.updateSelectedItemByIndex(e),this.canFocusSelectedItem()?this.navigator.isActive&&!this.isNestedElementFocused()&&this.focusSelectedItem():null===(t=this.getSelectedItemStrategy())||void 0===t||t.activate()}isNestedElementFocused(){if(!document.activeElement||!this.nestedContentSelected)return!1;return m.findItemElementIndexByChild(this.items,document.activeElement)===this.selectedItemIndex}updateSelectedItemByIndex(e){const t=this.selectedItemElement;this.selectedItemIndex=this.validateItemIndex(e),t&&this.selectedItemElement!==t&&(m.scheduleResetTabIndex(t),this.nestedContentSelected=!1),this.canFocusSelectedItem()&&m.makeElementFocusable(this.selectedItemElement)}canFocusSelectedItem(){return this.targetElement===this.selectedItemElement||!this.getSelectedItemStrategy()}leaveFromNestedContent(){this.nestedContentSelected=!1,this.focusSelectedItem()}moveToPrevItem(e=!1){this.selectedItemIndex>0?this.selectItem(this.selectedItemIndex-1):e&&this.selectItem(this.itemCount-1)}moveToNextItem(e=!1){this.selectedItemIndex<this.itemCount-1?this.selectItem(this.selectedItemIndex+1):e&&this.selectItem(0)}leaveBackward(){this.navigator.leaveFocus(!0)}leaveForward(){this.navigator.leaveFocus(!1)}handleKeyDown(e){const t=s.KeyUtils.getEventKeyCode(e);if(this.nestedContentSelected){if(t===s.KeyCode.Esc)return this.processEscapeKeyDown();if(t===s.KeyCode.Tab)return this.processTabKeyDown(e.shiftKey)}else if(t===s.KeyCode.Enter)return this.processEnter(e);return!1}handleKeyUp(e){return!1}processEscapeKeyDown(){return this.leaveFromNestedContent(),!0}processTabKeyDown(e){if(this.selectedItemElement){const t=m.findFocusableElements(this.selectedItemElement);if(t.length>0){const n=document.activeElement===t[0],s=document.activeElement===t[t.length-1];if(e&&n||!e&&s)return this.leaveFromNestedContent(),!0}}return!1}processEnter(e){return!(!this.isImmediatelyClickEnabled()||!this.processImmediatellyClick(e))||this.switchToNestedContent()}processImmediatellyClick(e){const t=m.findFocusableElements(this.selectedItemElement);return 1===t.length&&(this.raiseClickEvent(t[0],e.ctrlKey,e.metaKey,e.shiftKey),!0)}raiseClickEvent(e,t,n,s){const i=new MouseEvent("click",{bubbles:!0,cancelable:!0,ctrlKey:t,metaKey:n,shiftKey:s});e.dispatchEvent(i)}switchToNestedContent(){if(this.selectedItemElement){const e=m.findFocusableElements(this.selectedItemElement);if(e.length>0)return this.nestedContentSelected=!0,d(e[0]),!0}return!1}performShortcutEvent(e){this.navigator.dispatchShortcutEvent(e)}isImmediatelyClickEnabled(){return!1}canSwitchToNestedContentMode(){return!1}validateItemIndex(e){return e=Math.max(e,0),Math.min(e,this.items.length-1)}tryRestoreSelectedItem(e){if(e.isConnected){const t=this.items.indexOf(e);t>-1&&(this.selectedItemIndex=t)}}tryRestoreSelectedItemByIndex(e){if(e<0||e>=this.itemCount)return!1;return!!this.items[e].isConnected&&(this.selectedItemIndex=e,!0)}onActiveStateChanged(e){}static makeElementFocusable(e){e.tabIndex<0&&c(e,"tabIndex","0")}static removeTabIndex(e){c(e,"tabIndex")}static scheduleResetTabIndex(e){setTimeout((()=>{m.removeTabIndex(e)}),0)}static findPrevFocusableElement(e){const t=m.findFocusableElements(document),n=t.findIndex((t=>t===e))-1;return n>=0?t[n]:null}static findNextFocusableNotChildElement(e){const t=m.findFocusableElements(document),n=m.findFocusableElements(e),s=t.findIndex((t=>t===e))+n.length+1;return s<t.length?t[s]:null}static findFocusableElementInRootPath(e){var n;return null!==(n=[...t.getRootPathAndSelf(e)].find((e=>e.tabIndex>-1)))&&void 0!==n?n:null}static findFocusableElements(e){return Array.from(e.querySelectorAll(i)).filter((e=>e.tabIndex>-1&&(e.offsetWidth||e.offsetHeight||e.getClientRects().length)&&!n.isHidden(e)))}static findItemElementIndexByChild(e,n){return e.findIndex((e=>t.containsElement(e,n)))}}class u extends CustomEvent{constructor(e,t){super(u.eventName,{detail:new g(e,t),bubbles:!0,composed:!0,cancelable:!0})}}u.eventName="dxbl-keyboard-navigator.shortcut";class g{constructor(e,t){this.Event=e,this.Info=JSON.stringify(t)}}h.register(u.eventName,(e=>{const t=e.detail;return{Key:t.Event.key,Code:t.Event.code,CtrlKey:t.Event.ctrlKey,AltKey:t.Event.altKey,ShiftKey:t.Event.shiftKey,MetaKey:t.Event.metaKey,Info:t.Info}}));const v="dxbl-keyboard-navigator";var I;!function(e){e[e.None=0]="None",e[e.Backward=1]="Backward",e[e.Forward=2]="Forward"}(I||(I={}));class S extends HTMLElement{constructor(){super(),this._isActive=!1,this._leaveDirection=I.None,this._owner=null,this.rootStrategy=null,this.unsubscribeFocusHiding=null,this.strategies=new Map,this.contentChangedObserver=new MutationObserver(this.onContentChanged.bind(this))}get isActive(){return this._isActive}set isActive(e){this.updateActiveState(e)}get leaveDirection(){return this._leaveDirection}get initialized(){return!!this.rootStrategy}get targetElement(){return this.owner}get owner(){return this._owner}initialize(e,t){this._owner=e,this.rootStrategy=t,m.makeElementFocusable(this.targetElement),this.register(),this.unsubscribeFocusHiding=r(this.targetElement),this.attachStrategy(this.rootStrategy),this.rootStrategy.initialize()}disconnectedCallback(){this.disposeComponent()}disposeComponent(){var e;this.disposeStrategies(),this.rootStrategy=null,this.contentChangedObserver.disconnect(),null===(e=this.unsubscribeFocusHiding)||void 0===e||e.call(this),this.removeFocusHiddenClass(),f.remove(this)}attachStrategy(e){e&&this.strategies.set(e.targetElement,e)}getStrategy(e){return e&&this.strategies.has(e)?this.strategies.get(e):null}getIsNestedContentSelected(e){return this.getStrategiesPath(e).findIndex((e=>e.nestedContentSelected))>=0}onKeyDown(e,t){return this.handleKeyboardEvent(t,(t=>t.handleKeyDown(e)))}onKeyUp(e,t){return this.handleKeyboardEvent(t,(t=>t.handleKeyUp(e)))}dispatchShortcutEvent(e){const t=this.collectShortcutInfo(e);this.dispatchEvent(new u(e,t))}captureFocus(){var e;null===(e=this.findLastSelectedStrategy())||void 0===e||e.captureFocus()}leaveFocus(e){this._leaveDirection=e?I.Backward:I.Forward}getSelectedItemElement(){var e;return null===(e=this.findLastSelectedStrategy())||void 0===e?void 0:e.selectedItemElement}addFocusHiddenClass(){return a(this.targetElement),!0}removeFocusHiddenClass(){return this.targetElement&&o(this.targetElement),!0}passFocusHiddenClass(e){f.addFocusHiddenClasses(e)}updateSelectedItems(e,t){const n=this.getStrategiesPath(e);for(let s=0;s<n.length;s++){const i=0===s,r=n[s];r.updateSelectedItemByChildElement(e,t),r.canSwitchToNestedContentMode()&&(r.nestedContentSelected=i)}}activateStrategyTreeLine(e,t){var n;if(t&&this.tryActivateFromPreviousFocusedSibling(e))return;const s=e.target,i=this.getStrategiesPath(s);if(i.length>0){const e=i[0],t=e===this.rootStrategy;if(t&&e.activate(),!t||1===i.length){let t=e.selectedItemElement===s;if(!t){const i=m.findFocusableElementInRootPath(s);e.selectedItemElement!==i&&(null===(n=e.selectedItemElement)||void 0===n?void 0:n.contains(i))||(t=!0)}t&&(e.nestedContentSelected=!1,e.focusSelectedItem())}}}tryActivateFromPreviousFocusedSibling(e){const t=e.relatedTarget;if(!t||this.targetElement.contains(t))return!1;const n=e.target,s=m.findPrevFocusableElement(n),i=m.findNextFocusableNotChildElement(n);if(t!==s&&t!==i)return!1;const r=this.getStrategiesPath(n);if(r.length>0&&(r[0].nestedContentSelected=!1),this.rootStrategy){this.rootStrategy.updateSelectedItemByIndex(t===i?this.rootStrategy.itemCount-1:0),this.rootStrategy.activate()}return!0}updateActiveState(e){this._isActive!==e&&(this._isActive=e,this.strategies.forEach((t=>t.onActiveStateChanged(e))))}register(){this.contentChangedObserver.observe(this.targetElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["disabled"]}),f.register(this)}onContentChanged(){this.detachDisconnectedStrategies(),this.reinitialize()}reinitialize(){this.rootStrategy&&(this.rootStrategy.initialize(),this.isActive&&this.rootStrategy.activate())}getStrategiesPath(e){return y(e,this.strategies)}findLastSelectedStrategy(){var e,t;return null!==(t=null===(e=this.rootStrategy)||void 0===e?void 0:e.findLastSelectedStrategy())&&void 0!==t?t:null}handleKeyboardEvent(e,t){this._leaveDirection=I.None;const n=this.getStrategiesPath(e);for(let e=0;e<n.length;e++){const s=n[e];if(t(s))return!0;if(s.nestedContentSelected)return!1}return!1}detachDisconnectedStrategies(){var e;const t=Array.from(this.strategies.keys()).filter((e=>!e.isConnected));for(const n of t)null===(e=this.strategies.get(n))||void 0===e||e.onDispose(),this.strategies.delete(n)}disposeStrategies(){this.strategies.forEach((e=>e.onDispose()))}collectShortcutInfo(e){const t=this.getStrategiesPath(e.target).map((e=>e.getShortcutContext()));return Object.assign({},...t)}}function y(e,n){return function(e,t){const n=[];for(let s=0;s<e.length;s++){const i=e[s];if(t.has(i)){const e=t.get(i);e&&n.push(e)}}return n}([...t.getRootPathAndSelf(e)],n)}function E(e){return"getPortal"in e}const f=new class{constructor(){this.boundOnKeyDownHandler=this.handleKeyDown.bind(this),this.boundOnKeyUpHandler=this.handleKeyUp.bind(this),this.boundOnMouseDownHandler=this.handleMouseDown.bind(this),this.boundOnFocusInHandler=this.handleFocusIn.bind(this),this.navigators=new Map,this.lockTreeLineActivation=!1,document.addEventListener("keydown",this.boundOnKeyDownHandler,{capture:!0}),document.addEventListener("keyup",this.boundOnKeyUpHandler,{capture:!0}),document.addEventListener("mousedown",this.boundOnMouseDownHandler,{capture:!0}),document.addEventListener("focusin",this.boundOnFocusInHandler,{capture:!0})}register(e){const t=e.targetElement;this.navigators.has(t)||this.navigators.set(t,e)}remove(e){const t=e.targetElement;this.navigators.has(t)&&this.navigators.delete(t)}addFocusHiddenClasses(e){this.forEachNavigatorInTreeLine(e,(e=>e.addFocusHiddenClass()))}removeFocusHiddenClasses(e){this.forEachNavigatorInTreeLine(e,(e=>!e.removeFocusHiddenClass()))}handleKeyDown(e){this.handleKeyboardEvent(e,((t,n)=>t.onKeyDown(e,n)))}handleKeyUp(e){this.handleKeyboardEvent(e,((t,n)=>t.onKeyUp(e,n)))}handleKeyboardEvent(t,n){this.forEachNavigatorInTreeLine(t.target,((s,i,r,a)=>{if(n(s,i)){if(s.leaveDirection!==I.None){this.leaveFromNavigator(s,r<a.length-1?a[r+1]:null)}return e.markHandled(t,!1),this.removeFocusHiddenClasses(i),!0}return s.getIsNestedContentSelected(i)}))}handleMouseDown(e){this.activateTreeLine(e,!1),this.updateActiveState(e.target)}handleFocusIn(e){this.updateActiveState(e.target),this.activateTreeLine(e,!0)}getNavigatorsTreeLine(e){return function(e,t){let n=[];do{const s=y(e,t),i=s[s.length-1];n=n.concat(...s),e=i&&E(i)?i.getPortal():null}while(e);return n}(e,this.navigators)}activateTreeLine(e,t){this.lockTreeLineActivation||(this.lockTreeLineActivation=!0,this.forEachNavigatorInTreeLine(e.target,((n,s,i)=>(n.updateSelectedItems(s,t),0===i&&n.activateStrategyTreeLine(e,t),!1))),this.lockTreeLineActivation=!1)}forEachNavigatorInTreeLine(e,t){var n;const s=this.getNavigatorsTreeLine(e);for(let i=0;i<s.length;i++){const r=s[i];if(t(r,e,i,s))break;const a=E(r)?r:null;a&&(e=null!==(n=a.getPortal())&&void 0!==n?n:e)}}updateActiveState(e){let t=null;if(l(e)){const n=y(e,this.navigators);t=n.length>0?n[0]:null}this.navigators.forEach((e=>{e.isActive=e===t}))}leaveFromNavigator(e,t){const n=(e.leaveDirection===I.Backward?m.findPrevFocusableElement:m.findNextFocusableNotChildElement)(e.targetElement),s=null==t?void 0:t.getSelectedItemElement();!n||s&&!s.contains(n)?t&&t.captureFocus():d(n)}};customElements.define(v,S);export{S as D,m as K,I as L,v as a};
